# CommonKey

åŸºç¡€æŒ‰é”®å¤„ç†åº“ï¼Œå®ç°äº†ä¸€èˆ¬æŒ‰é”®çš„å•ç‚¹ã€è¿ç‚¹ã€é•¿æŒ‰æ£€æµ‹ã€‚å¯è¿›è¡Œå¤šæŒ‰é”®çš„å°è£…ï¼Œé‡‡ç”¨å›è°ƒçš„æ–¹å¼ä¸ä¸»ç¨‹åºé€šè®¯ã€‚

## ä½¿ç”¨è¯´æ˜

è¦ä½¿ç”¨[CommonKey][2]æŒ‰é”®æ£€æµ‹å°è£…ï¼Œä½ éœ€è¦åœ¨ä½ çš„å·¥ç¨‹ä¸­åšå‡ºå¦‚ä¸‹å¤„ç†ï¼š

* å°†æ–‡ä»¶åŠ å…¥ä½ çš„å·¥ç¨‹è·¯å¾„ä¸­ï¼ŒæŒ‰éœ€ä¿®æ”¹æ—¶é—´é˜ˆå€¼å®ï¼š

>    `COMKEY_ClickThreshold`ï¼šå•å‡»æ—¶é—´é˜ˆå€¼ï¼ŒçŸ­äºæ­¤æ—¶é—´è§†ä¸ºæŠ–åŠ¨
>
>    `COMKEY_HoldThreshold`ï¼šé•¿æŒ‰æ—¶é—´é˜ˆå€¼ï¼Œé•¿äºæ­¤æ—¶é—´è§†ä¸ºé•¿æŒ‰
>
>    `COMKEY_HoldTriggerThreshold`ï¼šé•¿æŒ‰è§¦å‘é˜ˆå€¼ï¼Œé•¿æŒ‰æ—¶æ¯éš”è¯¥äº‹ä»¶è§¦å‘ä¸€æ¬¡æŒ‰é”®
>
>    `COMKEY_IntervalVal`ï¼šé—´éš”æ—¶é—´é˜ˆå€¼ï¼ŒçŸ­äºæ­¤æ—¶é—´è§†ä¸ºè¿æŒ‰

* ä¸ºæ‚¨çš„æ¯ä¸ªæŒ‰é”®å®šä¹‰ä¸€ä¸ª`comkey_t`å¥æŸ„

* ä¸º**æ¯ä¸ªæŒ‰é”®**è°ƒç”¨`ComKey_Init`åˆå§‹åŒ–å‡½æ•°ï¼Œå‚æ•°ä¸º**æŒ‰é”®å¥æŸ„**å’Œ**æ£€æµ‹æ—¶é—´**

* æ”¹å†™`ComKey_SyncValue`å‡½æ•°

* æ ¹æ®éœ€è¦é‡å†™å›è°ƒå‡½æ•°ï¼š

>    `ComKey_FirstLongTriggerCallback`ï¼š**é¦–æ¬¡é•¿æŒ‰è§¦å‘å›è°ƒå‡½æ•°**ï¼Œå‚æ•°ä¸º**æŒ‰é”®å¥æŸ„**
>
>    `ComKey_LongHoldCallback`ï¼š**é•¿æŒ‰å›è°ƒå‡½æ•°**ï¼Œå‚æ•°ä¸º**æŒ‰é”®å¥æŸ„**
>
>    `ComKey_HoldTriggerCallback`ï¼š**é•¿æŒ‰è§¦å‘å›è°ƒå‡½æ•°**ï¼Œå‚æ•°ä¸º**æŒ‰é”®å¥æŸ„**
>
>    `ComKey_MultipleClickCallback`ï¼š**è¿ç‚¹å›è°ƒå‡½æ•°**ï¼Œå‚æ•°ä¸º**æŒ‰é”®å¥æŸ„**
>
>    `ComKey_KeyReleaseCallback`ï¼š**æŒ‰é”®æ¾å¼€å›è°ƒå‡½æ•°**ï¼Œå‚æ•°ä¸º**æŒ‰é”®å¥æŸ„**
>
>    `ComKey_KeyPressCallback`ï¼š**æŒ‰é”®æŒ‰ä¸‹å›è°ƒå‡½æ•°**ï¼Œå‚æ•°ä¸º**æŒ‰é”®å¥æŸ„**

* ä»¥ä¸€ä¸ªå›ºå®šçš„é—´éš”è°ƒç”¨`ComKey_Handler`å‡½æ•°

* æµ‹è¯•å®é™…æ•ˆæœ

***

## ä¸€äº›è¯´æ˜ä¸ç¤ºä¾‹

æ­¤éƒ¨åˆ†æä¾›äº†ä¸€äº›å¯¹äºæ¥å£å‡½æ•°ã€å›è°ƒå‡½æ•°ç­‰çš„è¯´æ˜ï¼Œä»¥åŠç®€å•çš„ä½¿ç”¨ç¤ºä¾‹ã€‚

### æ¥å£å‡½æ•°çš„ç§»æ¤

åº“å†…éƒ¨ä¸æä¾›å¯¹æŒ‰é”®è§¦å‘ç”µå¹³çš„æ£€æµ‹ï¼Œç§»æ¤æ—¶**è¯·åŠ¡å¿…**ä¿è¯æŒ‰é”®è§¦å‘æ—¶ä¼ é€’åˆ°`key->val`çš„å€¼ä¸º1ï¼›

å¦‚æœæ‚¨æœ‰å¤šä¸ªæŒ‰é”®ï¼Œè¯·é€šè¿‡**æ‚¨è‡ªå·±å®šä¹‰çš„æŒ‰é”®å¥æŸ„**æ¥åŒºåˆ†æ‚¨çš„è§¦å‘æŒ‰é”®ï¼›

æ­¤å¤–**è¯·ä¸è¦åˆ é™¤**æœ€åä¸€å¥ä»£ç ï¼Œè¿™å°†å½±å“ç¨‹åºçš„æ­£å¸¸è¿è¡Œã€‚

```C
void ComKey_SyncValue(comkey_t *key) {
    //if your key was pressed,"key->val" should be 1.
    if (key == &key0) {
        key->val = !HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_0);
    }
    if (key == &key1) {
        key->val = !HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_1);
    }

    //IMPORTANTï¼ï¼ï¼DO NOT MODIFIED!!!
    key->preVal = key->val;
}
```

### é¦–æ¬¡é•¿æŒ‰è§¦å‘å›è°ƒå‡½æ•°

å¦‚æœæ‚¨æœ‰å¤šä¸ªæŒ‰é”®ï¼Œè¯·é€šè¿‡**æ‚¨è‡ªå·±å®šä¹‰çš„æŒ‰é”®å¥æŸ„**æ¥åŒºåˆ†æ‚¨çš„è§¦å‘æŒ‰é”®ï¼›

è¯¥å›è°ƒå‡½æ•°ä¸ºè¿›å…¥é•¿æŒ‰çŠ¶æ€çš„ä¿¡å·ï¼Œæ­¤å‡½æ•°è¢«è°ƒç”¨æ„å‘³ç€æ‚¨çš„æŒ‰é”®**è¿›å…¥é•¿æŒ‰çŠ¶æ€**ã€‚

```C
__attribute__((weak)) void ComKey_FirstLongTriggerCallback(comkey_t* key)
{
    if (key == &key0)
        printf("key0: ");
    if (key == &key1) {
        printf("key1: ");
    }
    printf("was triggerred!\n", key->holdTime);
}
```

### é•¿æŒ‰å›è°ƒå‡½æ•°

å¦‚æœæ‚¨æœ‰å¤šä¸ªæŒ‰é”®ï¼Œè¯·é€šè¿‡**æ‚¨è‡ªå·±å®šä¹‰çš„æŒ‰é”®å¥æŸ„**æ¥åŒºåˆ†æ‚¨çš„è§¦å‘æŒ‰é”®ï¼›

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥é€šè¿‡æŒ‰é”®å¥æŸ„çš„`holdTime`æˆå‘˜æ¥è·å–**å½“æ¬¡é•¿æŒ‰çš„æŒç»­æ—¶é—´**ï¼ˆmsï¼‰ä¾›æ‚¨ä½¿ç”¨.

```C
void ComKey_LongHoldCallback(comkey_t *key) {
    if (key == &key0)
        printf("key0: ");
    if (key == &key1) {
        printf("key1: ");
    }
    printf("hold %ldms\n", key->holdTime);
}
```

### é•¿æŒ‰è§¦å‘å›è°ƒå‡½æ•°

å¦‚æœæ‚¨æœ‰å¤šä¸ªæŒ‰é”®ï¼Œè¯·é€šè¿‡**æ‚¨è‡ªå·±å®šä¹‰çš„æŒ‰é”®å¥æŸ„**æ¥åŒºåˆ†æ‚¨çš„è§¦å‘æŒ‰é”®ï¼›

å½“æ‚¨é‡‡ç”¨æŒ‰é”®å•å‡»è¿›è¡Œç±»ä¼¼æ•°æ®åŠ å‡çš„ä»»åŠ¡æ—¶ï¼Œè‹¥æƒ³**é€šè¿‡é•¿æŒ‰æ¥å®ç°å¤šæ¬¡å•å‡»çš„æ•ˆæœ**ï¼Œè¯·ä½¿ç”¨æ­¤å›è°ƒå‡½æ•°ï¼›

è¯¥å‡½æ•°å°†ä¼šä»¥`COMKEY_HoldTriggerThreshold`çš„é—´éš”è¢«è°ƒç”¨ã€‚

```C
void ComKey_HoldTriggerCallback(comkey_t *key) {
    if (key == &key0)
        printf("key0: HoldTrigger\n");
    if (key == &key1) {
        printf("key1: HoldTrigger\n");
    }
}
```

### è¿ç»­ç‚¹å‡»å›è°ƒå‡½æ•°

å¦‚æœæ‚¨æœ‰å¤šä¸ªæŒ‰é”®ï¼Œè¯·é€šè¿‡**æ‚¨è‡ªå·±å®šä¹‰çš„æŒ‰é”®å¥æŸ„**æ¥åŒºåˆ†æ‚¨çš„è§¦å‘æŒ‰é”®ï¼›

å½“æ‚¨å¤šæ¬¡è¿ç»­è¿›è¡Œç‚¹å‡»**å**ï¼Œä¼šè§¦å‘è¯¥å›è°ƒå‡½æ•°ï¼Œè¿ç»­ç‚¹å‡»é—´éš”æ—¶é—´é˜ˆå€¼å¯é€šè¿‡`COMKEY_IntervalVal`å®æ¥è¿›è¡Œä¿®æ”¹ï¼›

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥é€šè¿‡æŒ‰é”®å¥æŸ„çš„`clickCnt`æˆå‘˜æ¥è·å¾—å½“æ¬¡**è¿æŒ‰çš„æ¬¡æ•°**ä»¥ä¾›æ‚¨ä½¿ç”¨ã€‚

```C
void ComKey_MultipleClickCallback(comkey_t *key) {
    if (key == &key0)
        printf("key0: ");
    if (key == &key1) {
        printf("key1: ");
    }
    printf("click: %d\n", key->clickCnt);
}
```

### æŒ‰é”®æŒ‰ä¸‹å›è°ƒå‡½æ•°

å¦‚æœæ‚¨æœ‰å¤šä¸ªæŒ‰é”®ï¼Œè¯·é€šè¿‡**æ‚¨è‡ªå·±å®šä¹‰çš„æŒ‰é”®å¥æŸ„**æ¥åŒºåˆ†æ‚¨çš„è§¦å‘æŒ‰é”®ï¼›

ä»»ä½•æŒ‰é”®æŒ‰ä¸‹çš„äº‹ä»¶éƒ½ä¼šè§¦å‘è¯¥å›è°ƒå‡½æ•°ã€‚

```C
void ComKey_KeyPressCallback(comkey_t *key) {
    if (key == &key0) {
        printf("key0: ");
    }
    if (key == &key1) {
        printf("key1: ");
    }
    printf("keyPress!\n");
}
```

### æŒ‰é”®é‡Šæ”¾å›è°ƒå‡½æ•°

å¦‚æœæ‚¨æœ‰å¤šä¸ªæŒ‰é”®ï¼Œè¯·é€šè¿‡**æ‚¨è‡ªå·±å®šä¹‰çš„æŒ‰é”®å¥æŸ„**æ¥åŒºåˆ†æ‚¨çš„è§¦å‘æŒ‰é”®ï¼›

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥é€šè¿‡æŒ‰é”®å¥æŸ„çš„`state`æˆå‘˜çš„ä¸¤ä¸ªæšä¸¾å€¼ï¼š

`LongHold`å’Œ`MultiClick`

æ¥åŒºåˆ†å½“æ¬¡é‡Šæ”¾æŒ‰é”®çš„äº‹ä»¶æ˜¯**é•¿æŒ‰**è¿˜æ˜¯**è¿å‡»**ï¼ˆå•å‡»ï¼‰ã€‚

```C
void ComKey_KeyReleaseCallback(comkey_t *key) {
    if (key == &key0) {
        printf("key0: ");
    }
    if (key == &key1) {
        printf("key1: ");
    }

    if (key->state == LongHold) {
        printf("LongHold");
    } else if (key->state == MultiClick) {
        printf("Click");
    }
    printf(" Release!\n");
}
```



***

## å®ç°æ€è·¯

æ€è·¯å…¶å®å¾ˆç®€å•ï¼Œæ ¸å¿ƒéƒ¨åˆ†æ˜¯ä¸¤ä¸ªè®¡æ—¶å™¨ï¼š**æŒ‰ä¸‹è®¡æ—¶å™¨**å’Œ**é—´éš”è®¡æ—¶å™¨**ã€‚é€šè¿‡æœ‰é™çŠ¶æ€æœºçš„æ–¹å¼æ¥å®ç°å¯¹å„ä¸ªåŠŸèƒ½çš„æ£€æµ‹ï¼ŒçŠ¶æ€è½¬ç§»å›¾å¤§æ¦‚å¦‚ä¸‹ï¼š

![æŒ‰é”®çŠ¶æ€è½¬ç§»][3]

ä»…ä½œåˆ†äº«ï¼Œæ¬¢è¿æå‡ºä¼˜åŒ–æ„è§ä»¥åŠå»ºè®®ğŸ¥°


[1]: https://zhewana.cn/usr/uploads/2022/03/2707392082.png
[2]: https://github.com/Zhewana/CommonKey
[3]: https://zhewana.cn/usr/uploads/2022/03/3781171879.png
